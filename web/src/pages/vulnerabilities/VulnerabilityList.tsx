import { Suspense, useState, useCallback } from 'react'
import { Link } from 'react-router-dom'
import { graphql, useLazyLoadQuery, useMutation } from 'react-relay'
import { DataTable, FilterBar, Pagination, StatusBadge, Modal, ImportModal } from '../../components/common'
import { usePagination } from '../../hooks/usePagination'
import { useFilters } from '../../hooks/useFilters'
import { generateCsv, downloadFile } from '../../utils/csv'

/* ---------- GraphQL ---------- */

const VulnerabilityListQuery = graphql`
  query VulnerabilityListQuery($first: Int, $after: String, $filter: VulnFilter) {
    vulnerabilities(first: $first, after: $after, filter: $filter) {
      edges {
        node {
          id
          title
          severity
          cvssScore
          status
          source
          owner {
            id
            displayName
          }
          dueDate
          assets(first: 5) {
            totalCount
          }
          cveIds
          tags
        }
      }
      pageInfo {
        hasNextPage
        hasPreviousPage
        endCursor
        startCursor
      }
      totalCount
    }
  }
`

const CreateVulnerabilityMutation = graphql`
  mutation VulnerabilityListCreateMutation($input: CreateVulnerabilityInput!) {
    createVulnerability(input: $input) {
      id
      title
      severity
      cvssScore
      status
      source
      owner {
        id
        displayName
      }
      dueDate
      assets(first: 5) {
        totalCount
      }
      cveIds
      tags
    }
  }
`

const BulkUpdateVulnerabilitiesMutation = graphql`
  mutation VulnerabilityListBulkUpdateMutation($ids: [ID!]!, $input: BulkVulnUpdateInput!) {
    bulkUpdateVulnerabilities(ids: $ids, input: $input) {
      id
      status
      owner {
        id
        displayName
      }
    }
  }
`

/* ---------- Types ---------- */

interface VulnerabilityNode {
  id: string
  title: string
  severity: string
  cvssScore: number | null
  status: string
  source: string
  owner: { id: string; displayName: string } | null
  dueDate: string | null
  assets: { totalCount: number }
  cveIds: string[]
  tags: string[]
}

interface VulnFilters {
  [key: string]: string
  severity: string
  status: string
  source: string
  search: string
}

interface CreateFormState {
  title: string
  description: string
  source: string
  cveIds: string
  cvssScore: string
  cvssVector: string
  severity: string
  discoveryDate: string
  dueDate: string
  ownerId: string
  tags: string
  notes: string
}

/* ---------- Filter definitions ---------- */

const SEVERITY_OPTIONS = [
  { value: 'critical', label: 'Critical' },
  { value: 'high', label: 'High' },
  { value: 'medium', label: 'Medium' },
  { value: 'low', label: 'Low' },
  { value: 'info', label: 'Info' },
]

const STATUS_OPTIONS = [
  { value: 'new', label: 'New' },
  { value: 'triaged', label: 'Triaged' },
  { value: 'in_progress', label: 'In Progress' },
  { value: 'risk_accepted', label: 'Risk Accepted' },
  { value: 'mitigated', label: 'Mitigated' },
  { value: 'closed', label: 'Closed' },
]

const SOURCE_OPTIONS = [
  { value: 'scanner', label: 'Scanner' },
  { value: 'manual', label: 'Manual' },
  { value: 'pentest', label: 'Pentest' },
  { value: 'bug_bounty', label: 'Bug Bounty' },
]

const FILTER_FIELDS = [
  { key: 'severity', label: 'All Severities', type: 'select' as const, options: SEVERITY_OPTIONS },
  { key: 'status', label: 'All Statuses', type: 'select' as const, options: STATUS_OPTIONS },
  { key: 'source', label: 'All Sources', type: 'select' as const, options: SOURCE_OPTIONS },
  { key: 'search', label: 'Search', type: 'search' as const, placeholder: 'Search vulnerabilities...' },
]

/* ---------- Table columns ---------- */

const columns = [
  {
    key: 'title',
    header: 'Title',
    sortable: true,
    render: (item: VulnerabilityNode) => (
      <Link to={`/vulnerabilities/${item.id}`} className="font-medium text-primary-600 hover:text-primary-800 hover:underline">
        {item.title}
      </Link>
    ),
  },
  {
    key: 'severity',
    header: 'Severity',
    sortable: true,
    render: (item: VulnerabilityNode) => <StatusBadge status={item.severity} variant="severity" />,
  },
  {
    key: 'cvssScore',
    header: 'CVSS',
    sortable: true,
    render: (item: VulnerabilityNode) => (
      <span className="text-sm text-gray-900">{item.cvssScore != null ? item.cvssScore.toFixed(1) : '--'}</span>
    ),
  },
  {
    key: 'status',
    header: 'Status',
    sortable: true,
    render: (item: VulnerabilityNode) => <StatusBadge status={item.status} />,
  },
  {
    key: 'assets',
    header: 'Assets',
    render: (item: VulnerabilityNode) => (
      <span className="text-sm text-gray-600">{item.assets.totalCount}</span>
    ),
  },
  {
    key: 'owner',
    header: 'Owner',
    render: (item: VulnerabilityNode) => (
      <span className="text-sm text-gray-900">{item.owner?.displayName ?? '--'}</span>
    ),
  },
  {
    key: 'dueDate',
    header: 'Due Date',
    sortable: true,
    render: (item: VulnerabilityNode) => (
      <span className="text-sm text-gray-600">
        {item.dueDate ? new Date(item.dueDate).toLocaleDateString() : '--'}
      </span>
    ),
  },
]

/* ---------- Empty create-form state ---------- */

const EMPTY_CREATE_FORM: CreateFormState = {
  title: '',
  description: '',
  source: '',
  cveIds: '',
  cvssScore: '',
  cvssVector: '',
  severity: '',
  discoveryDate: '',
  dueDate: '',
  ownerId: '',
  tags: '',
  notes: '',
}

/* ---------- Inner data component (rendered inside Suspense) ---------- */

function VulnerabilityListInner() {
  const { filters, updateFilter, clearFilters } = useFilters<VulnFilters>({
    severity: '',
    status: '',
    source: '',
    search: '',
  })

  const { currentPage, pageSize, after, goToNextPage, goToPreviousPage, reset } = usePagination({ pageSize: 25 })

  // Build the filter object for the query, only including non-empty values
  const queryFilter: Record<string, string> = {}
  if (filters.severity) queryFilter.severity = filters.severity
  if (filters.status) queryFilter.status = filters.status
  if (filters.search) queryFilter.search = filters.search

  const data = useLazyLoadQuery<any>(VulnerabilityListQuery, {
    first: pageSize,
    after,
    filter: Object.keys(queryFilter).length > 0 ? queryFilter : null,
  })

  const vulnerabilities: VulnerabilityNode[] = (data.vulnerabilities?.edges ?? []).map(
    (edge: { node: VulnerabilityNode }) => edge.node,
  )

  const pageInfo = data.vulnerabilities?.pageInfo ?? {
    hasNextPage: false,
    hasPreviousPage: false,
    endCursor: null,
    startCursor: null,
  }
  const totalCount: number = data.vulnerabilities?.totalCount ?? 0

  /* --- Selection state --- */
  const [selectedIds, setSelectedIds] = useState<string[]>([])
  const hasSelection = selectedIds.length > 0

  /* --- Modal state --- */
  const [showCreateModal, setShowCreateModal] = useState(false)
  const [showBulkStatusModal, setShowBulkStatusModal] = useState(false)
  const [showBulkOwnerModal, setShowBulkOwnerModal] = useState(false)
  const [showImportModal, setShowImportModal] = useState(false)
  const [importingRows, setImportingRows] = useState(false)

  /* --- Create form state --- */
  const [createForm, setCreateForm] = useState<CreateFormState>(EMPTY_CREATE_FORM)
  const updateCreateField = useCallback(
    (field: keyof CreateFormState, value: string) =>
      setCreateForm((prev) => ({ ...prev, [field]: value })),
    [],
  )

  /* --- Bulk action state --- */
  const [bulkStatus, setBulkStatus] = useState('')
  const [bulkOwnerId, setBulkOwnerId] = useState('')

  /* --- Mutations --- */
  const [commitCreate, isCreating] = useMutation(CreateVulnerabilityMutation)
  const [commitBulkUpdate, isBulkUpdating] = useMutation(BulkUpdateVulnerabilitiesMutation)

  const handleCreate = () => {
    if (!createForm.title.trim()) return

    const input: Record<string, unknown> = {
      title: createForm.title.trim(),
    }
    if (createForm.description) input.description = createForm.description
    if (createForm.source) input.source = createForm.source
    if (createForm.cveIds) input.cveIds = createForm.cveIds.split(',').map((s) => s.trim()).filter(Boolean)
    if (createForm.cvssScore) input.cvssScore = parseFloat(createForm.cvssScore)
    if (createForm.cvssVector) input.cvssVector = createForm.cvssVector
    if (createForm.severity) input.severity = createForm.severity
    if (createForm.discoveryDate) input.discoveryDate = createForm.discoveryDate
    if (createForm.dueDate) input.dueDate = createForm.dueDate
    if (createForm.ownerId) input.ownerId = createForm.ownerId
    if (createForm.tags) input.tags = createForm.tags.split(',').map((s) => s.trim()).filter(Boolean)
    if (createForm.notes) input.notes = createForm.notes

    commitCreate({
      variables: { input },
      onCompleted: () => {
        setShowCreateModal(false)
        setCreateForm(EMPTY_CREATE_FORM)
        reset()
      },
      onError: (error: Error) => {
        console.error('Failed to create vulnerability:', error)
      },
    })
  }

  const handleBulkStatusChange = () => {
    if (!bulkStatus || selectedIds.length === 0) return

    commitBulkUpdate({
      variables: {
        ids: selectedIds,
        input: { status: bulkStatus },
      },
      onCompleted: () => {
        setShowBulkStatusModal(false)
        setBulkStatus('')
        setSelectedIds([])
      },
      onError: (error: Error) => {
        console.error('Failed to bulk update vulnerabilities:', error)
      },
    })
  }

  const handleBulkOwnerChange = () => {
    if (!bulkOwnerId || selectedIds.length === 0) return

    commitBulkUpdate({
      variables: {
        ids: selectedIds,
        input: { ownerId: bulkOwnerId },
      },
      onCompleted: () => {
        setShowBulkOwnerModal(false)
        setBulkOwnerId('')
        setSelectedIds([])
      },
      onError: (error: Error) => {
        console.error('Failed to bulk assign owner:', error)
      },
    })
  }

  const handleFilterChange = (key: string, value: string) => {
    updateFilter(key as keyof VulnFilters, value)
    reset()
  }

  const handleClearFilters = () => {
    clearFilters()
    reset()
  }

  /* --- Import / Export --- */
  const vulnImportFields = [
    { key: 'title', label: 'Title', required: true },
    { key: 'description', label: 'Description' },
    { key: 'source', label: 'Source' },
    { key: 'severity', label: 'Severity' },
    { key: 'cvssScore', label: 'CVSS Score' },
    { key: 'cvssVector', label: 'CVSS Vector' },
    { key: 'cveIds', label: 'CVE IDs' },
    { key: 'discoveryDate', label: 'Discovery Date' },
    { key: 'dueDate', label: 'Due Date' },
    { key: 'tags', label: 'Tags' },
    { key: 'notes', label: 'Notes' },
  ]

  const handleImportRows = (rows: Record<string, string>[]) => {
    setImportingRows(true)
    let completed = 0
    for (const row of rows) {
      const input: Record<string, unknown> = { title: row.title }
      if (row.description) input.description = row.description
      if (row.source) input.source = row.source
      if (row.severity) input.severity = row.severity.toLowerCase()
      if (row.cvssScore) input.cvssScore = parseFloat(row.cvssScore)
      if (row.cvssVector) input.cvssVector = row.cvssVector
      if (row.cveIds) input.cveIds = row.cveIds.split(',').map((s) => s.trim()).filter(Boolean)
      if (row.discoveryDate) input.discoveryDate = row.discoveryDate
      if (row.dueDate) input.dueDate = row.dueDate
      if (row.tags) input.tags = row.tags.split(',').map((s) => s.trim()).filter(Boolean)
      if (row.notes) input.notes = row.notes

      commitCreate({
        variables: { input },
        onCompleted: () => {
          completed++
          if (completed === rows.length) {
            setImportingRows(false)
            setShowImportModal(false)
            reset()
          }
        },
        onError: () => {
          completed++
          if (completed === rows.length) {
            setImportingRows(false)
            setShowImportModal(false)
            reset()
          }
        },
      })
    }
  }

  const handleExport = () => {
    const headers = ['Title', 'Severity', 'CVSS Score', 'Status', 'Source', 'Owner', 'Due Date', 'CVE IDs', 'Tags', 'Assets']
    const rows = vulnerabilities.map((v) => ({
      Title: v.title,
      Severity: v.severity,
      'CVSS Score': v.cvssScore != null ? String(v.cvssScore) : '',
      Status: v.status,
      Source: v.source,
      Owner: v.owner?.displayName ?? '',
      'Due Date': v.dueDate ?? '',
      'CVE IDs': v.cveIds.join(', '),
      Tags: v.tags.join(', '),
      Assets: String(v.assets.totalCount),
    }))
    const csv = generateCsv(headers, rows)
    downloadFile(csv, `vulnerabilities-export-${new Date().toISOString().slice(0, 10)}.csv`)
  }

  return (
    <div>
      {/* Page header */}
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold text-gray-900">Vulnerabilities</h1>
        <div className="flex gap-3">
          <button
            onClick={() => setShowImportModal(true)}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            Import
          </button>
          <button
            onClick={handleExport}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            Export
          </button>
          <button
            onClick={() => setShowCreateModal(true)}
            className="rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white hover:bg-primary-700"
          >
            Add Vulnerability
          </button>
        </div>
      </div>

      {/* Filter bar */}
      <FilterBar
        filters={FILTER_FIELDS}
        values={filters}
        onChange={handleFilterChange}
        onClear={handleClearFilters}
      />

      {/* Bulk action bar */}
      {hasSelection && (
        <div className="mb-4 flex items-center gap-3 rounded-lg bg-primary-50 px-4 py-2">
          <span className="text-sm font-medium text-primary-700">{selectedIds.length} selected</span>
          <button
            onClick={() => setShowBulkStatusModal(true)}
            className="text-sm font-medium text-primary-600 hover:text-primary-800"
          >
            Change Status
          </button>
          <button
            onClick={() => setShowBulkOwnerModal(true)}
            className="text-sm font-medium text-primary-600 hover:text-primary-800"
          >
            Assign Owner
          </button>
        </div>
      )}

      {/* Data table */}
      <DataTable
        columns={columns}
        data={vulnerabilities}
        keyExtractor={(item) => item.id}
        selectable
        onSelectionChange={setSelectedIds}
        emptyMessage="No vulnerabilities found."
        emptyAction={{ label: 'Add your first vulnerability', href: '#' }}
      />

      {/* Pagination */}
      <Pagination
        hasNextPage={pageInfo.hasNextPage}
        hasPreviousPage={pageInfo.hasPreviousPage}
        totalCount={totalCount}
        pageSize={pageSize}
        currentPage={currentPage}
        onNextPage={() => pageInfo.endCursor && goToNextPage(pageInfo.endCursor)}
        onPreviousPage={goToPreviousPage}
      />

      {/* Create vulnerability modal */}
      <Modal
        isOpen={showCreateModal}
        onClose={() => setShowCreateModal(false)}
        title="Add Vulnerability"
        size="lg"
        footer={
          <>
            <button
              onClick={() => setShowCreateModal(false)}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              onClick={handleCreate}
              disabled={!createForm.title.trim() || isCreating}
              className="rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white hover:bg-primary-700 disabled:opacity-50"
            >
              {isCreating ? 'Creating...' : 'Create Vulnerability'}
            </button>
          </>
        }
      >
        <div className="space-y-4">
          {/* Title */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">
              Title <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={createForm.title}
              onChange={(e) => updateCreateField('title', e.target.value)}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="e.g., SQL Injection in login endpoint"
            />
          </div>

          {/* Description */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">Description</label>
            <textarea
              value={createForm.description}
              onChange={(e) => updateCreateField('description', e.target.value)}
              rows={3}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="Detailed description of the vulnerability..."
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            {/* Source */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">Source</label>
              <select
                value={createForm.source}
                onChange={(e) => updateCreateField('source', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              >
                <option value="">Select source</option>
                {SOURCE_OPTIONS.map((opt) => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>

            {/* Severity */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">Severity</label>
              <select
                value={createForm.severity}
                onChange={(e) => updateCreateField('severity', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              >
                <option value="">Select severity</option>
                {SEVERITY_OPTIONS.map((opt) => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            {/* CVSS Score */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">CVSS Score</label>
              <input
                type="number"
                min="0"
                max="10"
                step="0.1"
                value={createForm.cvssScore}
                onChange={(e) => updateCreateField('cvssScore', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
                placeholder="0.0 - 10.0"
              />
            </div>

            {/* CVSS Vector */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">CVSS Vector</label>
              <input
                type="text"
                value={createForm.cvssVector}
                onChange={(e) => updateCreateField('cvssVector', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
                placeholder="CVSS:3.1/AV:N/AC:L/..."
              />
            </div>
          </div>

          {/* CVE IDs */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">CVE IDs</label>
            <input
              type="text"
              value={createForm.cveIds}
              onChange={(e) => updateCreateField('cveIds', e.target.value)}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="CVE-2024-1234, CVE-2024-5678"
            />
            <p className="mt-1 text-xs text-gray-500">Comma-separated list of CVE identifiers</p>
          </div>

          <div className="grid grid-cols-2 gap-4">
            {/* Discovery Date */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">Discovery Date</label>
              <input
                type="date"
                value={createForm.discoveryDate}
                onChange={(e) => updateCreateField('discoveryDate', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              />
            </div>

            {/* Due Date */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">Due Date</label>
              <input
                type="date"
                value={createForm.dueDate}
                onChange={(e) => updateCreateField('dueDate', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              />
            </div>
          </div>

          {/* Owner ID */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">Owner ID</label>
            <input
              type="text"
              value={createForm.ownerId}
              onChange={(e) => updateCreateField('ownerId', e.target.value)}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="User ID of the vulnerability owner"
            />
          </div>

          {/* Tags */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">Tags</label>
            <input
              type="text"
              value={createForm.tags}
              onChange={(e) => updateCreateField('tags', e.target.value)}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="web, api, authentication"
            />
            <p className="mt-1 text-xs text-gray-500">Comma-separated list of tags</p>
          </div>

          {/* Notes */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">Notes</label>
            <textarea
              value={createForm.notes}
              onChange={(e) => updateCreateField('notes', e.target.value)}
              rows={2}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="Internal notes..."
            />
          </div>
        </div>
      </Modal>

      {/* Bulk status change modal */}
      <Modal
        isOpen={showBulkStatusModal}
        onClose={() => setShowBulkStatusModal(false)}
        title="Change Status"
        size="sm"
        footer={
          <>
            <button
              onClick={() => setShowBulkStatusModal(false)}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              onClick={handleBulkStatusChange}
              disabled={!bulkStatus || isBulkUpdating}
              className="rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white hover:bg-primary-700 disabled:opacity-50"
            >
              {isBulkUpdating ? 'Updating...' : 'Update Status'}
            </button>
          </>
        }
      >
        <div>
          <label className="mb-1 block text-sm font-medium text-gray-700">
            New status for {selectedIds.length} vulnerabilit{selectedIds.length === 1 ? 'y' : 'ies'}
          </label>
          <select
            value={bulkStatus}
            onChange={(e) => setBulkStatus(e.target.value)}
            className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
          >
            <option value="">Select status</option>
            {STATUS_OPTIONS.map((opt) => (
              <option key={opt.value} value={opt.value}>{opt.label}</option>
            ))}
          </select>
        </div>
      </Modal>

      {/* Bulk owner assignment modal */}
      <Modal
        isOpen={showBulkOwnerModal}
        onClose={() => setShowBulkOwnerModal(false)}
        title="Assign Owner"
        size="sm"
        footer={
          <>
            <button
              onClick={() => setShowBulkOwnerModal(false)}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              onClick={handleBulkOwnerChange}
              disabled={!bulkOwnerId || isBulkUpdating}
              className="rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white hover:bg-primary-700 disabled:opacity-50"
            >
              {isBulkUpdating ? 'Assigning...' : 'Assign Owner'}
            </button>
          </>
        }
      >
        <div>
          <label className="mb-1 block text-sm font-medium text-gray-700">
            Owner for {selectedIds.length} vulnerabilit{selectedIds.length === 1 ? 'y' : 'ies'}
          </label>
          <input
            type="text"
            value={bulkOwnerId}
            onChange={(e) => setBulkOwnerId(e.target.value)}
            className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
            placeholder="Enter user ID"
          />
        </div>
      </Modal>

      {/* Import modal */}
      <ImportModal
        isOpen={showImportModal}
        onClose={() => setShowImportModal(false)}
        title="Import Vulnerabilities"
        fields={vulnImportFields}
        onImport={handleImportRows}
        importing={importingRows}
      />
    </div>
  )
}

/* ---------- Loading skeleton ---------- */

function VulnerabilityListSkeleton() {
  return (
    <div>
      <div className="mb-6 flex items-center justify-between">
        <div className="h-8 w-48 animate-pulse rounded bg-gray-200" />
        <div className="flex gap-3">
          <div className="h-9 w-20 animate-pulse rounded-lg bg-gray-200" />
          <div className="h-9 w-20 animate-pulse rounded-lg bg-gray-200" />
          <div className="h-9 w-36 animate-pulse rounded-lg bg-gray-200" />
        </div>
      </div>
      <div className="mb-4 flex gap-3">
        <div className="h-9 w-36 animate-pulse rounded-lg bg-gray-200" />
        <div className="h-9 w-36 animate-pulse rounded-lg bg-gray-200" />
        <div className="h-9 w-36 animate-pulse rounded-lg bg-gray-200" />
        <div className="h-9 w-48 animate-pulse rounded-lg bg-gray-200" />
      </div>
      <div className="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm">
        <div className="flex items-center justify-center py-12">
          <div className="h-8 w-8 animate-spin rounded-full border-4 border-gray-300 border-t-primary-600" />
        </div>
      </div>
    </div>
  )
}

/* ---------- Exported page component ---------- */

export default function VulnerabilityList() {
  return (
    <Suspense fallback={<VulnerabilityListSkeleton />}>
      <VulnerabilityListInner />
    </Suspense>
  )
}
