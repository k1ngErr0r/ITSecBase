import { Suspense, useState, useCallback } from 'react'
import { Link, useParams } from 'react-router-dom'
import { graphql, useLazyLoadQuery, useMutation } from 'react-relay'
import { StatusBadge, Modal, CommentThread, FileUpload } from '../../components/common'

/* ---------- GraphQL Queries ---------- */

const VulnerabilityDetailQuery = graphql`
  query VulnerabilityDetailQuery($id: ID!) {
    vulnerability(id: $id) {
      id
      title
      description
      source
      cveIds
      externalRefs
      cvssScore
      cvssVector
      severity
      status
      discoveryDate
      dueDate
      closureDate
      owner {
        id
        displayName
        email
      }
      analyst {
        id
        displayName
        email
      }
      approver {
        id
        displayName
        email
      }
      tags
      notes
      createdAt
      updatedAt
      assets(first: 20) {
        edges {
          node {
            id
            name
            assetType
            environment
          }
        }
        totalCount
      }
      history(first: 50) {
        edges {
          node {
            id
            fieldName
            oldValue
            newValue
            changedBy {
              id
              displayName
            }
            changedAt
          }
        }
        totalCount
      }
      comments(first: 20) {
        edges {
          node {
            id
            body
            author {
              id
              displayName
            }
            createdAt
            updatedAt
          }
        }
        totalCount
      }
      evidence(first: 20) {
        edges {
          node {
            id
            fileName
            fileSize
            contentType
            uploadedBy {
              id
              displayName
            }
            createdAt
          }
        }
        totalCount
      }
    }
  }
`

/* ---------- GraphQL Mutations ---------- */

const UpdateVulnerabilityMutation = graphql`
  mutation VulnerabilityDetailUpdateMutation($id: ID!, $input: UpdateVulnerabilityInput!) {
    updateVulnerability(id: $id, input: $input) {
      id
      title
      description
      source
      cveIds
      cvssScore
      cvssVector
      severity
      status
      discoveryDate
      dueDate
      closureDate
      owner {
        id
        displayName
        email
      }
      analyst {
        id
        displayName
        email
      }
      approver {
        id
        displayName
        email
      }
      tags
      notes
      updatedAt
    }
  }
`

const UpdateStatusMutation = graphql`
  mutation VulnerabilityDetailStatusMutation($id: ID!, $input: UpdateVulnerabilityInput!) {
    updateVulnerability(id: $id, input: $input) {
      id
      status
      updatedAt
    }
  }
`

const AddCommentMutation = graphql`
  mutation VulnerabilityDetailAddCommentMutation($input: AddCommentInput!) {
    addComment(input: $input) {
      id
      body
      author {
        id
        displayName
      }
      createdAt
      updatedAt
    }
  }
`

const UpdateCommentMutation = graphql`
  mutation VulnerabilityDetailUpdateCommentMutation($id: ID!, $input: UpdateCommentInput!) {
    updateComment(id: $id, input: $input) {
      id
      body
      updatedAt
    }
  }
`

const DeleteCommentMutation = graphql`
  mutation VulnerabilityDetailDeleteCommentMutation($id: ID!) {
    deleteComment(id: $id) {
      id
    }
  }
`

const UploadEvidenceMutation = graphql`
  mutation VulnerabilityDetailUploadEvidenceMutation($input: UploadEvidenceInput!) {
    uploadEvidence(input: $input) {
      id
      fileName
      fileSize
      contentType
      uploadedBy {
        id
        displayName
      }
      createdAt
    }
  }
`

/* ---------- Types ---------- */

type TabName = 'details' | 'assets' | 'history' | 'comments' | 'evidence'

interface PersonRef {
  id: string
  displayName: string
  email: string
}

interface AssetNode {
  id: string
  name: string
  assetType: string
  environment: string
}

interface HistoryNode {
  id: string
  fieldName: string
  oldValue: string | null
  newValue: string | null
  changedBy: { id: string; displayName: string }
  changedAt: string
}

interface CommentNode {
  id: string
  body: string
  author: { id: string; displayName: string }
  createdAt: string
  updatedAt: string
}

interface EvidenceNode {
  id: string
  fileName: string
  fileSize: number
  contentType: string
  uploadedBy: { id: string; displayName: string }
  createdAt: string
}

interface VulnerabilityData {
  id: string
  title: string
  description: string | null
  source: string
  cveIds: string[]
  externalRefs: string[]
  cvssScore: number | null
  cvssVector: string | null
  severity: string
  status: string
  discoveryDate: string | null
  dueDate: string | null
  closureDate: string | null
  owner: PersonRef | null
  analyst: PersonRef | null
  approver: PersonRef | null
  tags: string[]
  notes: string | null
  createdAt: string
  updatedAt: string
  assets: { edges: { node: AssetNode }[]; totalCount: number }
  history: { edges: { node: HistoryNode }[]; totalCount: number }
  comments: { edges: { node: CommentNode }[]; totalCount: number }
  evidence: { edges: { node: EvidenceNode }[]; totalCount: number }
}

interface EditFormState {
  title: string
  description: string
  source: string
  cveIds: string
  cvssScore: string
  cvssVector: string
  severity: string
  discoveryDate: string
  dueDate: string
  ownerId: string
  tags: string
  notes: string
}

/* ---------- Constants ---------- */

const TABS: { key: TabName; label: string }[] = [
  { key: 'details', label: 'Details' },
  { key: 'assets', label: 'Assets' },
  { key: 'history', label: 'History' },
  { key: 'comments', label: 'Comments' },
  { key: 'evidence', label: 'Evidence' },
]

const SEVERITY_OPTIONS = [
  { value: 'critical', label: 'Critical' },
  { value: 'high', label: 'High' },
  { value: 'medium', label: 'Medium' },
  { value: 'low', label: 'Low' },
  { value: 'info', label: 'Info' },
]

const SOURCE_OPTIONS = [
  { value: 'scanner', label: 'Scanner' },
  { value: 'manual', label: 'Manual' },
  { value: 'pentest', label: 'Pentest' },
  { value: 'bug_bounty', label: 'Bug Bounty' },
]

/** Maps current status to the available workflow transitions. */
const STATUS_TRANSITIONS: Record<string, { label: string; target: string; style: string }[]> = {
  new: [
    { label: 'Triage', target: 'triaged', style: 'bg-indigo-600 text-white hover:bg-indigo-700' },
  ],
  triaged: [
    { label: 'Start Work', target: 'in_progress', style: 'bg-yellow-600 text-white hover:bg-yellow-700' },
    { label: 'Accept Risk', target: 'risk_accepted', style: 'bg-orange-600 text-white hover:bg-orange-700' },
  ],
  in_progress: [
    { label: 'Mark Mitigated', target: 'mitigated', style: 'bg-green-600 text-white hover:bg-green-700' },
    { label: 'Accept Risk', target: 'risk_accepted', style: 'bg-orange-600 text-white hover:bg-orange-700' },
  ],
  risk_accepted: [
    { label: 'Reopen', target: 'triaged', style: 'bg-indigo-600 text-white hover:bg-indigo-700' },
    { label: 'Close', target: 'closed', style: 'bg-gray-600 text-white hover:bg-gray-700' },
  ],
  mitigated: [
    { label: 'Close', target: 'closed', style: 'bg-gray-600 text-white hover:bg-gray-700' },
    { label: 'Reopen', target: 'triaged', style: 'bg-indigo-600 text-white hover:bg-indigo-700' },
  ],
  closed: [
    { label: 'Reopen', target: 'triaged', style: 'bg-indigo-600 text-white hover:bg-indigo-700' },
  ],
}

/* ---------- Helpers ---------- */

function formatDate(dateStr: string | null | undefined): string {
  if (!dateStr) return '--'
  return new Date(dateStr).toLocaleDateString()
}

function formatDateTime(dateStr: string | null | undefined): string {
  if (!dateStr) return '--'
  const d = new Date(dateStr)
  return `${d.toLocaleDateString()} ${d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`
}

function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
}

/* ---------- Inner component ---------- */

function VulnerabilityDetailInner() {
  const { id } = useParams<{ id: string }>()

  const data = useLazyLoadQuery<any>(VulnerabilityDetailQuery, { id: id! })
  const vuln: VulnerabilityData = data.vulnerability

  /* --- Tab state --- */
  const [activeTab, setActiveTab] = useState<TabName>('details')

  /* --- Edit modal --- */
  const [showEditModal, setShowEditModal] = useState(false)
  const [editForm, setEditForm] = useState<EditFormState>({
    title: '',
    description: '',
    source: '',
    cveIds: '',
    cvssScore: '',
    cvssVector: '',
    severity: '',
    discoveryDate: '',
    dueDate: '',
    ownerId: '',
    tags: '',
    notes: '',
  })

  const openEditModal = useCallback(() => {
    setEditForm({
      title: vuln.title,
      description: vuln.description ?? '',
      source: vuln.source,
      cveIds: (vuln.cveIds ?? []).join(', '),
      cvssScore: vuln.cvssScore != null ? String(vuln.cvssScore) : '',
      cvssVector: vuln.cvssVector ?? '',
      severity: vuln.severity,
      discoveryDate: vuln.discoveryDate ?? '',
      dueDate: vuln.dueDate ?? '',
      ownerId: vuln.owner?.id ?? '',
      tags: (vuln.tags ?? []).join(', '),
      notes: vuln.notes ?? '',
    })
    setShowEditModal(true)
  }, [vuln])

  const updateEditField = useCallback(
    (field: keyof EditFormState, value: string) =>
      setEditForm((prev) => ({ ...prev, [field]: value })),
    [],
  )

  /* --- Mutations --- */
  const [commitUpdate, isUpdating] = useMutation(UpdateVulnerabilityMutation)
  const [commitStatusChange, isChangingStatus] = useMutation(UpdateStatusMutation)
  const [commitAddComment] = useMutation(AddCommentMutation)
  const [commitUpdateComment] = useMutation(UpdateCommentMutation)
  const [commitDeleteComment] = useMutation(DeleteCommentMutation)
  const [commitUploadEvidence] = useMutation(UploadEvidenceMutation)

  const handleUpdate = () => {
    if (!editForm.title.trim()) return

    const input: Record<string, unknown> = {
      title: editForm.title.trim(),
    }
    if (editForm.description !== (vuln.description ?? '')) input.description = editForm.description
    if (editForm.source !== vuln.source) input.source = editForm.source
    if (editForm.severity !== vuln.severity) input.severity = editForm.severity
    if (editForm.cvssScore) input.cvssScore = parseFloat(editForm.cvssScore)
    if (editForm.cvssVector) input.cvssVector = editForm.cvssVector
    if (editForm.cveIds) input.cveIds = editForm.cveIds.split(',').map((s) => s.trim()).filter(Boolean)
    if (editForm.discoveryDate) input.discoveryDate = editForm.discoveryDate
    if (editForm.dueDate) input.dueDate = editForm.dueDate
    if (editForm.ownerId) input.ownerId = editForm.ownerId
    if (editForm.tags) input.tags = editForm.tags.split(',').map((s) => s.trim()).filter(Boolean)
    input.notes = editForm.notes

    commitUpdate({
      variables: { id: vuln.id, input },
      onCompleted: () => setShowEditModal(false),
      onError: (error: Error) => console.error('Update failed:', error),
    })
  }

  const handleStatusChange = (targetStatus: string) => {
    commitStatusChange({
      variables: { id: vuln.id, input: { status: targetStatus } },
      onError: (error: Error) => console.error('Status change failed:', error),
    })
  }

  const handleAddComment = (body: string) => {
    commitAddComment({
      variables: { input: { vulnerabilityId: vuln.id, body } },
      onError: (error: Error) => console.error('Add comment failed:', error),
    })
  }

  const handleUpdateComment = (commentId: string, body: string) => {
    commitUpdateComment({
      variables: { id: commentId, input: { body } },
      onError: (error: Error) => console.error('Update comment failed:', error),
    })
  }

  const handleDeleteComment = (commentId: string) => {
    commitDeleteComment({
      variables: { id: commentId },
      onError: (error: Error) => console.error('Delete comment failed:', error),
    })
  }

  const handleUploadEvidence = (file: File) => {
    commitUploadEvidence({
      variables: {
        input: { vulnerabilityId: vuln.id, fileName: file.name, fileSize: file.size, contentType: file.type },
      },
      onError: (error: Error) => console.error('Upload failed:', error),
    })
  }

  /* --- Derived data --- */
  const assets: AssetNode[] = (vuln.assets?.edges ?? []).map((e: { node: AssetNode }) => e.node)
  const historyEntries: HistoryNode[] = (vuln.history?.edges ?? []).map((e: { node: HistoryNode }) => e.node)
  const comments: CommentNode[] = (vuln.comments?.edges ?? []).map((e: { node: CommentNode }) => e.node)
  const evidenceItems: EvidenceNode[] = (vuln.evidence?.edges ?? []).map((e: { node: EvidenceNode }) => e.node)
  const transitions = STATUS_TRANSITIONS[vuln.status] ?? []

  return (
    <div>
      {/* Back link + header */}
      <div className="mb-6">
        <Link to="/vulnerabilities" className="mb-3 inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700">
          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
          </svg>
          Back to Vulnerabilities
        </Link>
        <div className="flex items-center justify-between">
          <h1 className="text-2xl font-bold text-gray-900">{vuln.title}</h1>
          <div className="flex gap-3">
            {/* Status workflow buttons */}
            {transitions.map((t) => (
              <button
                key={t.target}
                onClick={() => handleStatusChange(t.target)}
                disabled={isChangingStatus}
                className={`rounded-lg px-4 py-2 text-sm font-semibold disabled:opacity-50 ${t.style}`}
              >
                {t.label}
              </button>
            ))}
            <button
              onClick={openEditModal}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              Edit
            </button>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 gap-6 lg:grid-cols-3">
        {/* Main content */}
        <div className="space-y-6 lg:col-span-2">
          {/* Tabs */}
          <div className="border-b border-gray-200">
            <nav className="-mb-px flex gap-6">
              {TABS.map((tab) => (
                <button
                  key={tab.key}
                  onClick={() => setActiveTab(tab.key)}
                  className={`border-b-2 px-1 py-3 text-sm font-medium ${
                    activeTab === tab.key
                      ? 'border-primary-600 text-primary-600'
                      : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </nav>
          </div>

          {/* Tab content */}
          <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
            {/* ---- DETAILS TAB ---- */}
            {activeTab === 'details' && (
              <div className="space-y-6">
                {/* Description */}
                <div>
                  <h3 className="mb-2 text-sm font-semibold text-gray-900">Description</h3>
                  <p className="whitespace-pre-wrap text-sm text-gray-700">
                    {vuln.description || 'No description provided.'}
                  </p>
                </div>

                {/* Notes */}
                {vuln.notes && (
                  <div>
                    <h3 className="mb-2 text-sm font-semibold text-gray-900">Notes</h3>
                    <p className="whitespace-pre-wrap text-sm text-gray-700">{vuln.notes}</p>
                  </div>
                )}

                {/* CVE IDs */}
                {vuln.cveIds && vuln.cveIds.length > 0 && (
                  <div>
                    <h3 className="mb-2 text-sm font-semibold text-gray-900">CVE Identifiers</h3>
                    <div className="flex flex-wrap gap-2">
                      {vuln.cveIds.map((cve) => (
                        <span
                          key={cve}
                          className="inline-flex items-center rounded-full bg-gray-100 px-3 py-0.5 text-xs font-medium text-gray-800"
                        >
                          {cve}
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                {/* External References */}
                {vuln.externalRefs && vuln.externalRefs.length > 0 && (
                  <div>
                    <h3 className="mb-2 text-sm font-semibold text-gray-900">External References</h3>
                    <ul className="list-inside list-disc space-y-1">
                      {vuln.externalRefs.map((ref: string, idx: number) => (
                        <li key={idx} className="text-sm">
                          <a href={ref} target="_blank" rel="noopener noreferrer" className="text-primary-600 hover:underline">
                            {ref}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                {/* CVSS Vector */}
                {vuln.cvssVector && (
                  <div>
                    <h3 className="mb-2 text-sm font-semibold text-gray-900">CVSS Vector</h3>
                    <code className="rounded bg-gray-100 px-2 py-1 text-xs text-gray-800">{vuln.cvssVector}</code>
                  </div>
                )}

                {/* Tags */}
                {vuln.tags && vuln.tags.length > 0 && (
                  <div>
                    <h3 className="mb-2 text-sm font-semibold text-gray-900">Tags</h3>
                    <div className="flex flex-wrap gap-2">
                      {vuln.tags.map((tag) => (
                        <span
                          key={tag}
                          className="inline-flex items-center rounded-full bg-primary-50 px-3 py-0.5 text-xs font-medium text-primary-700"
                        >
                          {tag}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ---- ASSETS TAB ---- */}
            {activeTab === 'assets' && (
              <div>
                <div className="mb-4 flex items-center justify-between">
                  <h3 className="text-sm font-semibold text-gray-900">
                    Linked Assets ({vuln.assets.totalCount})
                  </h3>
                </div>
                {assets.length === 0 ? (
                  <p className="text-sm text-gray-500">No assets linked to this vulnerability.</p>
                ) : (
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Name</th>
                        <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Type</th>
                        <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Environment</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {assets.map((asset) => (
                        <tr key={asset.id} className="hover:bg-gray-50">
                          <td className="whitespace-nowrap px-4 py-3 text-sm">
                            <Link to={`/assets/${asset.id}`} className="font-medium text-primary-600 hover:underline">
                              {asset.name}
                            </Link>
                          </td>
                          <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-600">
                            {asset.assetType.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase())}
                          </td>
                          <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-600">
                            {asset.environment.replace(/\b\w/g, (c) => c.toUpperCase())}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            )}

            {/* ---- HISTORY TAB ---- */}
            {activeTab === 'history' && (
              <div>
                <h3 className="mb-4 text-sm font-semibold text-gray-900">
                  Change History ({vuln.history.totalCount})
                </h3>
                {historyEntries.length === 0 ? (
                  <p className="text-sm text-gray-500">No changes recorded yet.</p>
                ) : (
                  <div className="space-y-0">
                    {historyEntries.map((entry, idx) => (
                      <div key={entry.id} className="flex gap-3">
                        {/* Timeline decoration */}
                        <div className="flex flex-col items-center">
                          <div className="mt-1 h-3 w-3 rounded-full bg-gray-300" />
                          {idx < historyEntries.length - 1 && (
                            <div className="w-px flex-1 bg-gray-200" />
                          )}
                        </div>
                        {/* Content */}
                        <div className="pb-6">
                          <p className="text-xs text-gray-500">{formatDateTime(entry.changedAt)}</p>
                          <p className="text-sm text-gray-900">
                            <span className="font-medium">{entry.changedBy.displayName}</span> changed{' '}
                            <span className="font-medium">{entry.fieldName.replace(/_/g, ' ')}</span>
                          </p>
                          <div className="mt-1 flex items-center gap-2 text-xs">
                            <span className="rounded bg-red-50 px-2 py-0.5 text-red-700 line-through">
                              {entry.oldValue || '(empty)'}
                            </span>
                            <svg className="h-3 w-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                            </svg>
                            <span className="rounded bg-green-50 px-2 py-0.5 text-green-700">
                              {entry.newValue || '(empty)'}
                            </span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* ---- COMMENTS TAB ---- */}
            {activeTab === 'comments' && (
              <div>
                <h3 className="mb-4 text-sm font-semibold text-gray-900">
                  Comments ({vuln.comments.totalCount})
                </h3>
                <CommentThread
                  comments={comments.map((c) => ({
                    id: c.id,
                    authorName: c.author.displayName,
                    body: c.body,
                    createdAt: c.createdAt,
                  }))}
                  onAdd={handleAddComment}
                  onUpdate={handleUpdateComment}
                  onDelete={handleDeleteComment}
                />
              </div>
            )}

            {/* ---- EVIDENCE TAB ---- */}
            {activeTab === 'evidence' && (
              <div className="space-y-6">
                <h3 className="text-sm font-semibold text-gray-900">
                  Evidence ({vuln.evidence.totalCount})
                </h3>

                <FileUpload
                  onUpload={handleUploadEvidence}
                  label="Upload evidence"
                  maxSizeMB={25}
                />

                {evidenceItems.length === 0 ? (
                  <p className="text-sm text-gray-500">No evidence files uploaded yet.</p>
                ) : (
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">File Name</th>
                        <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Size</th>
                        <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Type</th>
                        <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Uploaded By</th>
                        <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Date</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {evidenceItems.map((ev) => (
                        <tr key={ev.id} className="hover:bg-gray-50">
                          <td className="whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-900">
                            {ev.fileName}
                          </td>
                          <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-600">
                            {formatFileSize(ev.fileSize)}
                          </td>
                          <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-600">
                            {ev.contentType}
                          </td>
                          <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-600">
                            {ev.uploadedBy.displayName}
                          </td>
                          <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-600">
                            {formatDate(ev.createdAt)}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Right sidebar */}
        <div className="space-y-6">
          {/* Properties */}
          <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
            <h3 className="mb-4 text-sm font-semibold text-gray-900">Properties</h3>
            <dl className="space-y-3">
              <div>
                <dt className="text-xs font-medium text-gray-500">Severity</dt>
                <dd className="mt-1">
                  <StatusBadge status={vuln.severity} variant="severity" />
                </dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-gray-500">CVSS Score</dt>
                <dd className="mt-1 text-sm font-semibold text-gray-900">
                  {vuln.cvssScore != null ? vuln.cvssScore.toFixed(1) : '--'}
                </dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-gray-500">Status</dt>
                <dd className="mt-1">
                  <StatusBadge status={vuln.status} />
                </dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-gray-500">Source</dt>
                <dd className="mt-1 text-sm text-gray-900">
                  {vuln.source.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase())}
                </dd>
              </div>
            </dl>
          </div>

          {/* People */}
          <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
            <h3 className="mb-4 text-sm font-semibold text-gray-900">People</h3>
            <dl className="space-y-3">
              <div>
                <dt className="text-xs font-medium text-gray-500">Owner</dt>
                <dd className="mt-1 text-sm text-gray-900">
                  {vuln.owner ? (
                    <div>
                      <span className="font-medium">{vuln.owner.displayName}</span>
                      <span className="ml-1 text-xs text-gray-500">{vuln.owner.email}</span>
                    </div>
                  ) : '--'}
                </dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-gray-500">Analyst</dt>
                <dd className="mt-1 text-sm text-gray-900">
                  {vuln.analyst ? (
                    <div>
                      <span className="font-medium">{vuln.analyst.displayName}</span>
                      <span className="ml-1 text-xs text-gray-500">{vuln.analyst.email}</span>
                    </div>
                  ) : '--'}
                </dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-gray-500">Approver</dt>
                <dd className="mt-1 text-sm text-gray-900">
                  {vuln.approver ? (
                    <div>
                      <span className="font-medium">{vuln.approver.displayName}</span>
                      <span className="ml-1 text-xs text-gray-500">{vuln.approver.email}</span>
                    </div>
                  ) : '--'}
                </dd>
              </div>
            </dl>
          </div>

          {/* Dates */}
          <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
            <h3 className="mb-4 text-sm font-semibold text-gray-900">Dates</h3>
            <dl className="space-y-3">
              <div>
                <dt className="text-xs font-medium text-gray-500">Discovery Date</dt>
                <dd className="mt-1 text-sm text-gray-900">{formatDate(vuln.discoveryDate)}</dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-gray-500">Due Date</dt>
                <dd className="mt-1 text-sm text-gray-900">{formatDate(vuln.dueDate)}</dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-gray-500">Closure Date</dt>
                <dd className="mt-1 text-sm text-gray-900">{formatDate(vuln.closureDate)}</dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-gray-500">Created</dt>
                <dd className="mt-1 text-sm text-gray-900">{formatDateTime(vuln.createdAt)}</dd>
              </div>
              <div>
                <dt className="text-xs font-medium text-gray-500">Last Updated</dt>
                <dd className="mt-1 text-sm text-gray-900">{formatDateTime(vuln.updatedAt)}</dd>
              </div>
            </dl>
          </div>
        </div>
      </div>

      {/* Edit modal */}
      <Modal
        isOpen={showEditModal}
        onClose={() => setShowEditModal(false)}
        title="Edit Vulnerability"
        size="lg"
        footer={
          <>
            <button
              onClick={() => setShowEditModal(false)}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              onClick={handleUpdate}
              disabled={!editForm.title.trim() || isUpdating}
              className="rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white hover:bg-primary-700 disabled:opacity-50"
            >
              {isUpdating ? 'Saving...' : 'Save Changes'}
            </button>
          </>
        }
      >
        <div className="space-y-4">
          {/* Title */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">
              Title <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={editForm.title}
              onChange={(e) => updateEditField('title', e.target.value)}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
            />
          </div>

          {/* Description */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">Description</label>
            <textarea
              value={editForm.description}
              onChange={(e) => updateEditField('description', e.target.value)}
              rows={4}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            {/* Source */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">Source</label>
              <select
                value={editForm.source}
                onChange={(e) => updateEditField('source', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              >
                <option value="">Select source</option>
                {SOURCE_OPTIONS.map((opt) => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>

            {/* Severity */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">Severity</label>
              <select
                value={editForm.severity}
                onChange={(e) => updateEditField('severity', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              >
                <option value="">Select severity</option>
                {SEVERITY_OPTIONS.map((opt) => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            {/* CVSS Score */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">CVSS Score</label>
              <input
                type="number"
                min="0"
                max="10"
                step="0.1"
                value={editForm.cvssScore}
                onChange={(e) => updateEditField('cvssScore', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
                placeholder="0.0 - 10.0"
              />
            </div>

            {/* CVSS Vector */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">CVSS Vector</label>
              <input
                type="text"
                value={editForm.cvssVector}
                onChange={(e) => updateEditField('cvssVector', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
                placeholder="CVSS:3.1/AV:N/AC:L/..."
              />
            </div>
          </div>

          {/* CVE IDs */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">CVE IDs</label>
            <input
              type="text"
              value={editForm.cveIds}
              onChange={(e) => updateEditField('cveIds', e.target.value)}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="CVE-2024-1234, CVE-2024-5678"
            />
            <p className="mt-1 text-xs text-gray-500">Comma-separated list of CVE identifiers</p>
          </div>

          <div className="grid grid-cols-2 gap-4">
            {/* Discovery Date */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">Discovery Date</label>
              <input
                type="date"
                value={editForm.discoveryDate}
                onChange={(e) => updateEditField('discoveryDate', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              />
            </div>

            {/* Due Date */}
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">Due Date</label>
              <input
                type="date"
                value={editForm.dueDate}
                onChange={(e) => updateEditField('dueDate', e.target.value)}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              />
            </div>
          </div>

          {/* Owner ID */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">Owner ID</label>
            <input
              type="text"
              value={editForm.ownerId}
              onChange={(e) => updateEditField('ownerId', e.target.value)}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="User ID of the owner"
            />
          </div>

          {/* Tags */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">Tags</label>
            <input
              type="text"
              value={editForm.tags}
              onChange={(e) => updateEditField('tags', e.target.value)}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="web, api, authentication"
            />
            <p className="mt-1 text-xs text-gray-500">Comma-separated list of tags</p>
          </div>

          {/* Notes */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">Notes</label>
            <textarea
              value={editForm.notes}
              onChange={(e) => updateEditField('notes', e.target.value)}
              rows={3}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
              placeholder="Internal notes..."
            />
          </div>
        </div>
      </Modal>
    </div>
  )
}

/* ---------- Loading skeleton ---------- */

function VulnerabilityDetailSkeleton() {
  return (
    <div>
      <div className="mb-6">
        <div className="mb-3 h-4 w-40 animate-pulse rounded bg-gray-200" />
        <div className="flex items-center justify-between">
          <div className="h-8 w-64 animate-pulse rounded bg-gray-200" />
          <div className="flex gap-3">
            <div className="h-9 w-24 animate-pulse rounded-lg bg-gray-200" />
            <div className="h-9 w-16 animate-pulse rounded-lg bg-gray-200" />
          </div>
        </div>
      </div>
      <div className="grid grid-cols-1 gap-6 lg:grid-cols-3">
        <div className="space-y-6 lg:col-span-2">
          <div className="h-10 w-full animate-pulse rounded bg-gray-200" />
          <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
            <div className="space-y-3">
              <div className="h-4 w-full animate-pulse rounded bg-gray-200" />
              <div className="h-4 w-5/6 animate-pulse rounded bg-gray-200" />
              <div className="h-4 w-4/6 animate-pulse rounded bg-gray-200" />
            </div>
          </div>
        </div>
        <div className="space-y-6">
          <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
            <div className="space-y-3">
              <div className="h-4 w-20 animate-pulse rounded bg-gray-200" />
              <div className="h-6 w-16 animate-pulse rounded-full bg-gray-200" />
              <div className="h-4 w-20 animate-pulse rounded bg-gray-200" />
              <div className="h-4 w-12 animate-pulse rounded bg-gray-200" />
              <div className="h-4 w-20 animate-pulse rounded bg-gray-200" />
              <div className="h-4 w-24 animate-pulse rounded bg-gray-200" />
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

/* ---------- Exported page component ---------- */

export default function VulnerabilityDetail() {
  return (
    <Suspense fallback={<VulnerabilityDetailSkeleton />}>
      <VulnerabilityDetailInner />
    </Suspense>
  )
}
